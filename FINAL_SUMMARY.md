# Итоговый отчёт по реализации Raydium V4 AMM Swap Tool

## Обзор проекта

Успешно реализован инструмент командной строки для выполнения токен-свопов через Raydium V4 AMM на блокчейне Solana. Инструмент полностью работает on-chain, без использования внешних API для выполнения транзакций.

## Реализованные фазы

### ✅ Фаза 1: Управление приватным ключом
- Загрузка приватного ключа из переменной окружения `SOLANA_PRIVATE_KEY`
- Валидация ключа и вывод публичного адреса
- Флаг `-execute` для активации режима выполнения

### ✅ Фаза 2: Интерактивное подтверждение
- Детальный вывод информации о свопе перед выполнением
- Интерактивный запрос подтверждения (y/n)
- Расчёт и отображение цены

### ✅ Фаза 3: Управление slippage
- Запрос максимального slippage у пользователя
- Значение по умолчанию: 0.5%
- Расчёт минимальной выходящей суммы с учётом slippage

### ✅ Фаза 4: Построение инструкции свопа
- Структура `SwapInstructionData` для Raydium V4
- Сериализация с использованием `github.com/gagliardetto/binary`
- Правильное упорядочивание аккаунтов для разных направлений свопа

### ✅ Фаза 5: Управление токен-аккаунтами
- Автоматическое создание Associated Token Accounts (ATA)
- Проверка существования ATA перед созданием
- Интеграция в процесс построения транзакции

### ✅ Фаза 6: Выполнение транзакции
- Построение полной транзакции с множественными инструкциями
- Обработка WSOL (wrapping/unwrapping)
- Подписание и отправка транзакции
- Ожидание подтверждения через WebSocket

### ✅ Фаза 7: Парсинг результатов
- Получение деталей выполненной транзакции
- Извлечение фактических сумм из pre/post балансов
- Обработка как токен-балансов, так и SOL-балансов

### ✅ Фаза 8: Генерация отчёта
- Структура `TransactionReport` с полными деталями
- Расчёт фактической цены исполнения
- Вычисление реального slippage
- Красивый вывод отчёта с ссылкой на explorer

## Технические особенности

### Обработка WSOL
- **При покупке токена**: SOL → WSOL (wrap) → Token
  - Создание WSOL ATA
  - Перевод SOL на ATA
  - Синхронизация native balance
  
- **При продаже токена**: Token → WSOL → SOL (unwrap)
  - Выполнение свопа в WSOL
  - Закрытие WSOL ATA для unwrap

### Определение направления свопа
Корректная логика определения `isBaseToQuote` в зависимости от:
- Позиции SOL/WSOL в паре (base или quote)
- Типа операции (buy или sell)

### Расчёт decimals
Динамическое получение decimals для токенов из on-chain данных, что обеспечивает корректные расчёты для любых токенов.

## Ограничения и предположения

1. **Только WSOL** - пользователь работает с wrapped SOL, инструмент автоматически выполняет wrap/unwrap
2. **Helius RPC** - используется для надёжного доступа к блокчейну
3. **Только Raydium V4** - поддерживаются только пулы версии 4
4. **Нет защиты от MEV** - транзакции могут быть подвержены front-running
5. **Mainnet** - инструмент настроен для работы с mainnet

## Использованные библиотеки

- `github.com/gagliardetto/solana-go` - основная библиотека для работы с Solana
- `github.com/gagliardetto/binary` - сериализация инструкций в формате Solana
- Стандартные библиотеки Go для остального функционала

## Примеры использования

```bash
# Установка приватного ключа
export SOLANA_PRIVATE_KEY=your_private_key_here

# Покупка токена за 0.1 SOL
go run main.go -pool 58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2 -amount 0.1 -side buy -execute

# Продажа токенов за SOL
go run main.go -pool 58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2 -amount 1000 -side sell -execute
```

## Результат

Инструмент полностью функционален и готов к использованию для выполнения свопов через Raydium V4 AMM. Все поставленные задачи выполнены, включая бонусную задачу по расчёту фактического slippage между ожидаемой и реальной ценой исполнения.